# SOCKS5-WebSocket 代理系统开发任务清单

## 项目概述

使用 Go 语言开发支持 SOCKS5 和 WebSocket 协议的网络代理系统

## 已完成任务

- [x] 项目初始化（go.mod 创建）
- [x] 配置文件解析功能实现
- [x] 配置文件模板和说明文档创建

## 待完成任务

### 1. 项目基础结构搭建

- [x] 创建项目目录结构
  - [x] 创建`config/`目录 - 配置文件
  - [x] 创建`internal/`目录 - 内部包
  - [x] 创建`pkg/`目录 - 可重用包
  - [x] 创建`cmd/`目录 - 命令行入口
  - [x] 创建`examples/`目录 - 示例配置
  - [x] 创建`tests/`目录 - 测试文件

### 2. 核心接口定义

- [x] 定义统一客户端接口`ProxyClient`
- [x] 定义统一服务端接口`ProxyServer`
- [x] 定义配置结构体`ClientConfig`和`ServerConfig`
- [x] 定义上游连接配置`UpstreamConfig`
- [x] 创建客户端和服务端工厂函数

### 3. SOCKS5 组件实现

- [x] 实现 SOCKS5 客户端
  - [x] 基础连接功能
  - [x] 用户名密码认证
  - [x] 数据转发
- [x] 实现 SOCKS5 服务端
  - [x] 监听和连接处理
  - [x] 认证验证
  - [x] 数据转发
  - [x] 集成 gitee.com/masx200/go-socks5 库
  - [x] 删除后备方案代码

### 4. WebSocket 组件实现

- [x] 实现 WebSocket 客户端
  - [x] 基础连接功能
  - [x] HTTP Headers 认证
  - [x] 数据转发
- [x] 实现 WebSocket 服务端
  - [x] HTTP 服务端和 WebSocket 升级
  - [x] 认证信息解析
  - [x] 数据转发

### 5. 上游连接选择器

- [x] 实现 TCP 直连模式
- [x] 实现 WebSocket 代理模式
- [x] 实现 SOCKS5 代理模式
- [x] 实现动态选择机制
  - [x] 轮询策略
  - [x] 随机策略
  - [x] 加权策略
  - [x] 故障转移策略
  - [x] 健康检查机制

### 6. 配置管理

- [x] 实现配置文件解析
- [x] 实现配置热重载
- [x] 创建配置文件模板

### 7. 日志系统

- [x] 实现服务端连接成功和失败日志打印
  - [x] SOCKS5 服务端连接日志
  - [x] WebSocket 服务端连接日志

### 10. 文档和示例

- [x] API 文档
- [x] 使用示例
- [x] 部署说明
- [x] 配置文件示例

## 开发优先级

1. **高优先级**：核心接口定义、SOCKS5 组件、WebSocket 组件、上游连接选择器
2. **中优先级**：配置管理、日志系统、测试开发
3. **低优先级**：文档示例、构建部署、高级功能

## 当前进度

- 项目初始化：✅ 完成
- 核心开发：✅ 完成（上游连接选择器已完成）
- 配置管理：✅ 完成（配置文件解析已完成）
- 测试验证：✅ 完成（DynamicUpstreamSelector 负载均衡策略测试已完成）
- 文档完善：🔄 进行中（配置文件模板已创建）

## 依赖库

- `golang.org/x/net/websocket`
- `golang.org/x/net/proxy` (SOCKS5 支持)
- `github.com/gorilla/websocket` (WebSocket 支持)
- `gitee.com/masx200/go-socks5`

## 更新记录

- 2025-06-17：创建任务清单，开始项目开发
- 2025-06-18：完成上游连接选择器实现，支持多种选择策略和健康检查
- 2025-06-20：完成配置文件解析功能，支持 JSON
  格式配置文件，创建配置文件模板和说明文档
- 2025-06-23：修改 UpstreamType 从数字类型改为字符串类型，更新配置文件中的 type
  字段为字符串格式
- 2025-06-23：编写完整的 README.md
  文档，包含项目概述、功能特性、安装使用、配置说明、开发指南等内容
- 2025-09-06：修改 SOCKS5 服务端使用 gitee.com/masx200/go-socks5
  库，修复编译错误
- 2025-09-06：删除 SOCKS5 服务端后备方案代码，完全依赖
  gitee.com/masx200/go-socks5 库
- 2025-09-06：为服务端添加连接成功和失败日志打印功能，包括 SOCKS5 和 WebSocket
  服务端的详细连接状态日志
- 2025-09-06：修复 SOCKS5
  客户端地址解析问题，解决尾部斜杠导致端口解析错误的问题，在 parseServerAddr
  函数中添加 strings.TrimSuffix 处理
- 2025-09-06：修改 WebSocket 协议实现，将 targetHost 和 targetPort 从 URL
  查询参数移动到 HTTP Headers 中，提高安全性
- 2025-09-06：完善 SOCKS5 和 WebSocket
  服务端的日志打印功能，统一日志前缀格式，添加连接状态、认证信息、上游选择、数据转发等详细日志信息
- 2025-09-06：修复 WebSocket 服务端空指针解引用错误，解决在
  SelectUpstreamConnection 方法中因 selector 初始化不当导致的 panic 问题，优化
  NewWebSocketServer 函数的 selector 初始化逻辑
- 2025-09-06：修复 WebSocket 服务端 interface{} 类型 nil 检查问题，添加
  isNilInterface 函数使用反射正确检查包含 nil 指针的 interface{}，解决在
  Upstream selector enabled: false 情况下仍进入选择器分支的问题
- 2025-09-06：实现客户端连接关闭 callback 功能，为 ProxyClient 接口添加
  SetConnectionClosedCallback
  方法，支持连接关闭时自动退出程序，替换原来的轮询检查机制，提高效率和可靠性
- 2025-09-07：实现 DynamicUpstreamSelector 负载均衡策略测试，完成
  selectRoundRobin、selectRandom、selectWeighted、selectFailover
  四种策略的全面测试用例，包括单元测试、并发测试和基准测试，确保代码质量和性能
- 2025-09-08：:feat(proxy): 为 ProxyClient 接口添加 DialContext 方法，实现
  WebSocketClient 和 SOCKS5Client 的 DialContext 方法，支持通过 context
  控制连接建立过程。使用 net.Pipe 创建连接并通过 goroutine
  处理连接和转发数据，提高连接建立的灵活性和可控性。
- 2025-09-11：添加 HTTP 代理支持，包括：
  - 在 interfaces 包中添加 HTTP 代理类型常量
  - 创建 HTTP 代理适配器，将 HTTP 代理客户端与系统接口集成
  - 修改 proxy 包中的工厂函数，支持 HTTP 代理客户端创建
  - 更新 main.go 文件中的命令行参数描述，添加 HTTP 代理类型
  - 现在支持通过命令行参数配置 HTTP 代理作为上游连接
- 2025-09-11：增强 SOCKS5 客户端地址解析功能，添加对 socks5://和
  socks5s://协议前缀的支持：
  - socks5://前缀等同于 tcp://，使用普通 TCP 连接
  - socks55s://前缀等同于 tls://，使用 TLS 加密连接
  - 现在 SOCKS5 客户端支持 tcp://、tls://、socks5://、socks5s://四种协议前缀
- 2025-09-13：添加 DOH (DNS-over-HTTPS) 服务器支持：
  - 添加命令行参数 -dohurl、-dohip、-dohalpn 用于配置 DOH 服务器
  - 集成 github.com/masx200/http-proxy-go-server/resolver 包
  - 当提供 DOH 参数时，使用 CreateHostsAndDohResolver 创建自定义 DNS 解析器
  - 修改 SOCKS5 和 WebSocket 服务器以支持 NameResolver 参数
  - 更新上游选择器，在直连模式下使用自定义解析器解析域名
  - 支持 h2 和 h3 ALPN 协议，可配置多个 DOH 服务器
- 2025-09-13：优化 createDirectConnection 函数：
  - 优先使用 NameResolver.LookupIP 方法获取所有IP地址
  - 按照解析到的IP地址列表依次尝试连接，直到连接成功
  - 增强连接可靠性和负载均衡能力
  - 添加详细的连接尝试日志记录

# 添加命令行参数支持和 HTTP 上游代理功能

## Core Features

- 命令行参数解析

- HTTP 上游代理支持

- 代理认证功能

- 灵活配置选项

## Tech Stack

{ "language": "Go", "libraries": [ "flag", "net/http", "net/url" ] }

## Design

通过添加 HTTP 代理类型常量和适配器，将 HTTP
代理客户端与系统接口集成，实现命令行参数配置 HTTP 代理的功能。

## Plan

Note:

- [ ] is holding
- [/] is doing
- [x] is done

---

[X] 添加命令行参数解析功能

[X] 实现 HTTP 上游代理客户端

[X] 集成 HTTP 上游代理到现有 SOCKS5 服务器

[X] 添加上游代理认证支持

[X] 更新主函数以使用命令行配置

# DOH (DNS-over-HTTPS) 支持

## Core Features

- DOH 服务器配置支持
- 自定义 DNS 解析器集成
- 命令行参数解析
- 多协议 ALPN 支持 (h2, h3)

## Tech Stack

{ "language": "Go", "libraries": [
"github.com/masx200/http-proxy-go-server/resolver" ] }

## Design

通过集成外部 resolver 包，为 SOCKS5 和 WebSocket 代理服务器添加 DOH
支持，提供安全可靠的 DNS 解析功能。

## Plan

Note:

- [ ] is holding
- [/] is doing
- [x] is done

---

[X] 添加 DOH 命令行参数支持 (-dohurl, -dohip, -dohalpn)

[X] 集成 CreateHostsAndDohResolver 函数

[X] 修改 SOCKS5 服务器支持 NameResolver 参数

[X] 修改 WebSocket 服务器支持 NameResolver 参数

[X] 更新上游选择器使用自定义解析器

[X] 支持多个 DOH 服务器配置

[X] 集成 ALPN 协议支持 (h2, h3)

## 使用示例

```bash
# 使用单个 DOH 服务器
go run cmd/main.go -protocol socks5 -addr :1080 -dohurl "https://dns.google/dns-query"

# 使用多个 DOH 服务器，指定 IP 和 ALPN
go run cmd/main.go -protocol socks5 -addr :1080 \
  -dohurl "https://dns.google/dns-query" -dohip "8.8.8.8" -dohalpn "h2" \
  -dohurl "https://cloudflare-dns.com/dns-query" -dohip "1.1.1.1" -dohalpn "h3"
```
