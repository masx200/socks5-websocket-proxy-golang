# SOCKS5-WebSocket 代理系统开发规范

## 项目概述

使用 Go 语言开发一个支持 SOCKS5 和 WebSocket
协议的网络代理系统，实现多种协议间的灵活转发和统一接口封装。该系统旨在提供高性能、可扩展的代理解决方案，支持多种上游连接方式和动态配置。

## 核心架构设计

### 系统组件图

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   SOCKS5 Client │    │ WebSocket Client│    │   Direct Client │
└─────────┬───────┘    └─────────┬───────┘    └─────────┬───────┘
          │                      │                      │
          └──────────────────────┼──────────────────────┘
                                 │
                    ┌─────────────▼─────────────┐
                    │   Upstream Selector       │
                    │  (动态选择上游连接方式)     │
                    └─────────────┬─────────────┘
                                 │
          ┌──────────────────────┼──────────────────────┐
          │                      │                      │
┌─────────▼───────┐    ┌─────────▼───────┐    ┌─────────▼───────┐
│   SOCKS5 Server │    │ WebSocket Server│    │   Direct Server │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

### 核心功能模块

#### 1. 协议组件实现

##### SOCKS5 组件

- **SOCKS5 客户端** (`pkg/socks5/client.go`)

  - 实现 SOCKS5 协议客户端功能
  - 支持用户名密码认证 (RFC 1929)
  - 支持域名解析和 IPv4/IPv6 连接
  - 实现连接建立、数据转发和连接管理

- **SOCKS5 服务端** (`pkg/socks5/server.go`)
  - 实现 SOCKS5 协议服务端功能
  - 支持用户名密码认证
  - 支持多客户端并发连接
  - 集成上游连接选择器

##### WebSocket 组件

- **WebSocket 客户端** (`pkg/websocket/client.go`)

  - 实现 WebSocket 协议客户端功能
  - 支持通过 HTTP Headers 传递认证信息
  - 实现连接建立、数据转发和连接管理
  - 支持连接重试和错误恢复

- **WebSocket 服务端** (`pkg/websocket/server.go`)
  - 实现 WebSocket 协议服务端功能
  - 支持从 HTTP Headers 解析认证信息
  - 支持多客户端并发连接
  - 集成上游连接选择器

#### 2. 认证机制设计

##### 认证流程

```go
// 认证接口统一封装
type Authenticator interface {
    Authenticate(username, password string) bool
    ValidateCredentials(credentials map[string]string) error
}
```

##### SOCKS5 认证实现

- 遵循 SOCKS5 协议标准认证流程 (RFC 1928, RFC 1929)
- 支持无认证和用户名密码认证两种方式
- 认证失败时返回标准错误码

##### WebSocket 认证实现

- 直接通过 HTTP Headers 传递认证信息
- 认证参数：`X-Proxy-Username`, `X-Proxy-Password`
- 传输方式：HTTP Headers 直接传递
- 明文传输用户名和密码到请求头中

#### 3. 数据转发引擎

##### 转发模式支持

- **WebSocket ↔ SOCKS5**：协议间转发
- **WebSocket ↔ Direct**：直连转发
- **SOCKS5 ↔ Direct**：直连转发
- **SOCKS5 ↔ WebSocket**：协议间转发

##### 数据流处理

```go
// 数据转发接口
type DataForwarder interface {
    ForwardData(srcConn, dstConn net.Conn) error

}
```

#### 4. 上游连接选择器

##### 选择策略

- **TCP 直连** (`direct`)：直接与目标主机建立 TCP 连接
- **WebSocket 代理** (`websocket`)：通过 WebSocket 代理连接
- **SOCKS5 代理** (`socks5`)：通过 SOCKS5 代理连接

##### 动态选择机制

- 基于配置的静态选择

- 支持配置热更新

## 技术实现规范

### 接口设计规范

#### 统一客户端接口 (`pkg/interfaces/interfaces.go`)

```go
// ProxyClient 统一客户端接口
type ProxyClient interface {
    Connect(targetHost string, targetPort int) error
    Authenticate(username, password string) error
    ForwardData(conn net.Conn) error
    Close() error

    SetTimeout(timeout time.Duration)
}

// 客户端配置结构
type ClientConfig struct {
    Username   string            `json:"username"`
    Password   string            `json:"password"`
    ServerAddr string            `json:"server_addr"`
    Protocol   string            `json:"protocol"` // "socks5" or "websocket"
    Timeout    time.Duration     `json:"timeout"`

}
```

#### 统一服务端接口 (`pkg/interfaces/interfaces.go`)

```go
// ProxyServer 统一服务端接口
type ProxyServer interface {
    Listen(address string) error
    HandleConnection(conn net.Conn) error
    Authenticate(username, password string) bool
    SelectUpstreamConnection(targetHost string, targetPort int) (net.Conn, error)
    Shutdown() error

    ReloadConfig(config *ServerConfig) error
}

// 服务端配置结构
type ServerConfig struct {
    ListenAddr     string            `json:"listen_addr"`
    AuthUsers      map[string]string `json:"auth_users"`
    Protocol       string            `json:"protocol"`
    Timeout        time.Duration     `json:"timeout"`
    UpstreamConfig []UpstreamConfig   `json:"upstream_config"`
    EnableUpstream bool              `json:"enable_upstream"`

}
```

#### 上游连接配置

```go
// 上游连接类型
type UpstreamType string

const (
    UpstreamDirect    UpstreamType = "direct"
    UpstreamWebSocket UpstreamType = "websocket"
    UpstreamSOCKS5    UpstreamType = "socks5"
)

// 上游连接配置
type UpstreamConfig struct {
    Type          UpstreamType    `json:"type"`
    ProxyAddress  string          `json:"proxy_address"`
    ProxyUsername string          `json:"proxy_username"`
    ProxyPassword string          `json:"proxy_password"`
    Timeout       time.Duration   `json:"timeout"`
    RetryCount    int             `json:"retry_count"`

}
```

### 依赖库管理

```go
// go.mod 依赖
require (
    github.com/gorilla/websocket v1.5.0
    github.com/armon/go-socks5 v0.0.0-20160902105147-7670d434d4f1
    golang.org/x/net v0.17.0
    golang.org/x/proxy v0.15.0
)
```

#### 推荐库说明

- `github.com/gorilla/websocket`：WebSocket 协议实现，性能优异
- `github.com/armon/go-socks5`：SOCKS5 协议实现，功能完整
- `golang.org/x/net`：网络相关工具包
- `golang.org/x/proxy`：代理相关工具包

#### 并发处理

- 使用 goroutine 池管理并发连接
- 实现连接数限制和超时控制
- 支持优雅关闭和资源清理
- 实现背压机制防止过载

#### 内存优化

- 使用缓冲池减少内存分配
- 实现零拷贝数据传输
- 支持流式处理大文件

#### 配置热更新

- 支持配置文件监听和自动重载
- 实现配置验证和错误处理
- 支持运行时配置修改
- 实现配置版本管理和回滚

### 集成测试要求

#### 协议间转发测试

- SOCKS5 ↔ WebSocket 转发测试
- 不同认证方式的兼容性测试
- 上游连接切换的可靠性测试

### 上游连接选择测试

#### 测试场景

- TCP 直连模式测试
- WebSocket 代理模式测试
- SOCKS5 代理模式测试

#### 测试指标

- 连接建立成功率
- 数据传输完整性
- 故障恢复时间
- 切换延迟时间

## 部署规范

### 部署方式

```bash
# 编译
go build -o proxy-server.exe cmd/main.go

# 运行
./proxy-server.exe
```

## 开发流程规范

### 代码质量要求

#### 代码风格

- 使用 `go fmt` 格式化代码
- 使用 `go vet` 检查代码问题
- 使用 `golint` 检查代码规范
- 使用 `go test` 运行单元测试

#### 代码审查

- 所有代码变更需要经过代码审查
- 审查重点：功能正确性、性能影响、安全性
- 审查通过后才能合并到主分支

## 问答记录

### 需求确认

**Q1: 你希望这个代理系统主要用于什么场景？**\
A1: 通用 TCP 代理，支持多种协议间的灵活转发

**Q2: 关于用户名/密码验证，你希望采用什么具体的认证机制？**\
A2: 静态身份认证，支持配置文件中的用户名密码对

**Q3: 在协议转换方面，是否需要处理特定类型的流量？**\
A3: 不需要特殊协议，只需要处理 TCP 协议的数据流转发

**Q4: 你对性能和资源占用有什么特别要求吗？**\
A4: 无特殊要求，但需要支持并发连接处理和基本的内存优化

**Q5: 你是否需要支持 IPv6 或其他特定网络协议？**\
A5: 需要支持 IPv6、IPv4 和域名解析

## 交付标准

### 文档交付

- 详细的 API 文档
- 配置文件模板和说明
- 部署和运维文档
- 开发者指南

## 开发执行流程

### 开发步骤

1. 运行 `go fmt ./...` 格式化代码
2. 修复语法错误和编译问题
3. 根据 `TASK_LIST.md` 任务清单进行开发
4. 使用 `go build ./...` 进行编译验证
5. 运行测试确保功能正确性
6. 继续按照任务清单进行下一阶段开发
7. 然后修改任务清单

## 测试步骤

### WebSocket 协议测试

```bash
./proxy-server.exe -mode server -protocol websocket -addr :1080
```

```bash
./proxy-server.exe -mode client -protocol websocket -addr ws://localhost:1080/ -host www.example.com -port 80
```

### SOCKS5 协议测试

```bash
./proxy-server.exe -mode server -protocol socks5 -addr :1080
```

```bash
./proxy-server.exe -mode client -protocol socks5 -addr tcp://localhost:1080/ -host www.example.com -port 80
```

## 配置文件测试

```bash
go run -v cmd/main.go -config ./config/server-config.json
```
