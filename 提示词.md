# SOCKS5-WebSocket 代理系统开发规范

## 项目概述

使用 Go 语言开发一个支持 SOCKS5 和 WebSocket
协议的网络代理系统，实现多种协议间的灵活转发和统一接口封装。

## 核心功能要求

### 1. 协议组件实现

#### SOCKS5 组件

- **SOCKS5 客户端**：实现 SOCKS5 协议客户端功能，支持用户名密码认证
- **SOCKS5 服务端**：实现 SOCKS5 协议服务端功能，支持用户名密码认证

#### WebSocket 组件

- **WebSocket 客户端**：实现 WebSocket 协议客户端功能，支持通过 HTTP Headers
  传递认证信息
- **WebSocket 服务端**：实现 WebSocket 协议服务端功能，支持从 HTTP Headers
  解析认证信息

### 2. 认证机制

- **认证方式**：静态用户名密码认证
- **SOCKS5 认证**：遵循 SOCKS5 协议标准认证流程
- **WebSocket 认证**：通过 URL 查询参数序列化认证信息，并嵌入 HTTP Headers
  - 认证参数：username, password, host, port
  - 序列化方式：URL 查询参数格式
  - 传输方式：HTTP Headers

### 3. 数据转发功能

- **协议支持**：纯 TCP 数据流转发
- **转发模式**：
  - WebSocket ↔ SOCKS5 下游连接
  - WebSocket ↔ SOCKS5 上游连接
  - 直连模式
- **上游连接选择**：
  - **TCP 直连**：直接与目标主机建立 TCP 连接
  - **WebSocket 代理**：通过 WebSocket 代理连接到目标主机
  - **SOCKS5 代理**：通过 SOCKS5 代理连接到目标主机
- **动态选择**：根据配置动态选择上游连接方式，支持运行时切换
- **网络支持**：IPv4、IPv6、域名解析

### 4. 接口统一封装

#### 客户端统一接口

```go
// 统一客户端接口
type ProxyClient interface {
    Connect(targetHost string, targetPort int) error
    Authenticate(username, password string) error
    ForwardData(conn net.Conn) error
    Close() error
}

// 客户端创建工厂
func CreateClient(protocol string, config ClientConfig) (ProxyClient, error)
```

#### 服务端统一接口

```go
// 统一服务端接口
type ProxyServer interface {
    Listen(address string) error
    HandleConnection(conn net.Conn) error
    Authenticate(username, password string) bool
    // 上游连接选择器：根据配置选择连接上游TCP连接的方式
    SelectUpstreamConnection(targetHost string, targetPort int) (net.Conn, error)
    Shutdown() error
}

// 服务端创建工厂
func CreateServer(protocol string, config ServerConfig) (ProxyServer, error)

// 上游连接类型
type UpstreamType string

const (
    UpstreamDirect    UpstreamType = "direct"    // TCP直连
    UpstreamWebSocket UpstreamType = "websocket" // WebSocket代理
    UpstreamSOCKS5    UpstreamType = "socks5"    // SOCKS5代理
)

// 上游连接配置
type UpstreamConfig struct {
    Type          UpstreamType // 连接类型
    ProxyAddress  string      // 代理地址（当Type为websocket或socks5时需要）
    ProxyUsername string      // 代理用户名（可选）
    ProxyPassword string      // 代理密码（可选）
    Timeout       time.Duration // 连接超时时间
}
```

## 技术规范

### 依赖库要求

- 允许使用第三方库
- 推荐库：
- `golang.org/x/net/websocket`
- `golang.org/x/net/proxy` (SOCKS5支持)
- `github.com/gorilla/websocket` (WebSocket支持)
- `github.com/armon/go-socks5`

### 配置管理

```go
// 客户端配置
type ClientConfig struct {
    Username   string
    Password   string
    ServerAddr string
    Protocol   string // "socks5" or "websocket"
    Timeout    time.Duration
}

// 服务端配置
type ServerConfig struct {
    ListenAddr     string                    // 监听地址
    AuthUsers      map[string]string        // username:password
    Protocol       string                    // "socks5" or "websocket"
    Timeout        time.Duration            // 连接超时时间
    UpstreamConfig *UpstreamConfig          // 上游连接配置（可选，未配置时使用直连）
    EnableUpstream bool                     // 是否启用上游连接选择器
}
```

### 错误处理

- 实现统一的错误类型
- 提供详细的错误信息
- 支持错误恢复机制
- 上游连接失败时的降级处理机制

### 日志记录

- 实现结构化日志
- 记录连接、认证、转发等关键操作
- 支持不同日志级别
- 记录上游连接选择和切换过程

### 上游连接选择实现

- **负载均衡**：支持多个上游代理的负载均衡
- **故障转移**：当某个上游连接失败时自动切换到备用连接
- **健康检查**：定期检查上游连接的可用性
- **配置热更新**：支持运行时更新上游连接配置

## 性能要求

- 支持并发连接处理

- 内存使用优化
- 无特殊性能和资源占用限制

## 测试要求

- 单元测试覆盖所有核心功能
- 集成测试验证协议间转发
- 性能测试评估并发处理能力
- 认证测试验证安全性
- **上游连接选择测试**：
  - 测试 TCP 直连、WebSocket 代理、SOCKS5 代理三种模式的正确性
  - 测试上游连接切换的可靠性
  - 测试故障转移机制的有效性

- **配置测试**：验证上游连接配置的正确加载和应用

## 部署要求

- 支持跨平台部署
- 提供配置文件示例
- 实现优雅关闭
- 支持热重载配置

## 问答记录

### 需求确认

**Q1: 你希望这个代理系统主要用于什么场景？** A1: 通用 TCP 代理

**Q2: 关于用户名/密码验证，你希望采用什么具体的认证机制？** A2: 静态身份认证

**Q3: 在协议转换方面，是否需要处理特定类型的流量？** A3:
不需要特殊协议，只需要处理 TCP 协议

**Q4: 你对性能和资源占用有什么特别要求吗？** A4: 无要求

**Q5: 你是否需要支持 IPv6 或其他特定网络协议？** A5: 需要支持 IPv6、IPv4 和域名

## 交付标准

- 完整的 Go 源代码
- 详细的 API 文档
- 配置文件模板
- 使用示例和测试用例
- 部署说明文档
